"""
Telegram API ì´ˆê¸° ì„¤ì • ìŠ¤í¬ë¦½íŠ¸

Telegram í´ë¼ì´ì–¸íŠ¸ ì„¸ì…˜ì„ ìƒì„±í•˜ê³  ì¸ì¦ì„ ì™„ë£Œí•©ë‹ˆë‹¤.
ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ìµœì´ˆ 1íšŒë§Œ ì‹¤í–‰í•˜ë©´ ë©ë‹ˆë‹¤.
"""

import asyncio
import os
from dotenv import load_dotenv
from telethon import TelegramClient

# í™˜ê²½ë³€ìˆ˜ ë¡œë“œ
load_dotenv()

# Telegram API ì„¤ì •
API_ID = int(os.getenv("API_ID"))
API_HASH = os.getenv("API_HASH")
SESSION_NAME = os.getenv("SESSION_NAME", "channel_copier")


async def setup_telegram():
    """Telegram í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸° ì„¤ì •"""
    print("=" * 80)
    print("ğŸš€ Telegram API ì´ˆê¸° ì„¤ì • ì‹œì‘")
    print("=" * 80)

    # ì„¸ì…˜ íŒŒì¼ì´ ì´ë¯¸ ìˆëŠ”ì§€ í™•ì¸
    session_file = f"{SESSION_NAME}.session"
    if os.path.exists(session_file):
        print(f"âš ï¸  ì„¸ì…˜ íŒŒì¼ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤: {session_file}")
        response = input("ê¸°ì¡´ ì„¸ì…˜ì„ ì‚­ì œí•˜ê³  ìƒˆë¡œ ì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): ")
        if response.lower() != 'y':
            print("âŒ ì„¤ì •ì„ ì·¨ì†Œí•©ë‹ˆë‹¤.")
            return
        os.remove(session_file)
        print(f"âœ… ê¸°ì¡´ ì„¸ì…˜ íŒŒì¼ ì‚­ì œ: {session_file}")

    print()
    print("ğŸ“± Telegram ë¡œê·¸ì¸ì„ ì‹œì‘í•©ë‹ˆë‹¤...")
    print("ğŸ’¡ ì „í™”ë²ˆí˜¸ëŠ” êµ­ì œ í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: +821012345678)")
    print()

    # Telegram í´ë¼ì´ì–¸íŠ¸ ìƒì„±
    client = TelegramClient(SESSION_NAME, API_ID, API_HASH)

    try:
        # í´ë¼ì´ì–¸íŠ¸ ì‹œì‘ (ì „í™”ë²ˆí˜¸ ë° ì¸ì¦ ì½”ë“œ ì…ë ¥)
        await client.start()

        # ë¡œê·¸ì¸ ì„±ê³µ í™•ì¸
        me = await client.get_me()
        print()
        print("=" * 80)
        print("âœ… Telegram ë¡œê·¸ì¸ ì„±ê³µ!")
        print(f"ğŸ‘¤ ì‚¬ìš©ì: {me.first_name} (@{me.username})")
        print(f"ğŸ“ ì „í™”ë²ˆí˜¸: {me.phone}")
        print(f"ğŸ’¾ ì„¸ì…˜ íŒŒì¼: {session_file}")
        print("=" * 80)
        print()
        print("ğŸ’¡ ì´ì œ auto_trading.pyë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
        print()

    except Exception as e:
        print()
        print("=" * 80)
        print(f"âŒ Telegram ì„¤ì • ì‹¤íŒ¨: {e}")
        print("=" * 80)
        print()
        print("ğŸ’¡ .env íŒŒì¼ì˜ API_IDì™€ API_HASHë¥¼ í™•ì¸í•˜ì„¸ìš”.")
        print("ğŸ’¡ https://my.telegram.org/auth ì—ì„œ ë°œê¸‰ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
        print()

    finally:
        # í´ë¼ì´ì–¸íŠ¸ ì¢…ë£Œ
        await client.disconnect()
        print("âœ… í´ë¼ì´ì–¸íŠ¸ ì—°ê²° ì¢…ë£Œ")


async def test_telegram_connection():
    """Telegram ì—°ê²° í…ŒìŠ¤íŠ¸"""
    print("=" * 80)
    print("ğŸ” Telegram ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘")
    print("=" * 80)

    # ì„¸ì…˜ íŒŒì¼ í™•ì¸
    session_file = f"{SESSION_NAME}.session"
    if not os.path.exists(session_file):
        print(f"âŒ ì„¸ì…˜ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤: {session_file}")
        print("ğŸ’¡ ë¨¼ì € Telegram ì„¤ì •ì„ ì™„ë£Œí•˜ì„¸ìš”.")
        return

    print(f"âœ… ì„¸ì…˜ íŒŒì¼ í™•ì¸: {session_file}")
    print()

    # Telegram í´ë¼ì´ì–¸íŠ¸ ìƒì„±
    client = TelegramClient(SESSION_NAME, API_ID, API_HASH)

    try:
        # í´ë¼ì´ì–¸íŠ¸ ì‹œì‘
        await client.start()

        # ë¡œê·¸ì¸ í™•ì¸
        me = await client.get_me()
        print("âœ… Telegram ë¡œê·¸ì¸ ì„±ê³µ!")
        print(f"ğŸ‘¤ ì‚¬ìš©ì: {me.first_name} (@{me.username})")
        print(f"ğŸ“ ì „í™”ë²ˆí˜¸: {me.phone}")
        print()

        # SOURCE_CHANNEL í™•ì¸
        source_channel = os.getenv("SOURCE_CHANNEL")
        if source_channel:
            print(f"ğŸ“¥ SOURCE_CHANNEL í™•ì¸ ì¤‘: {source_channel}")
            try:
                entity = await client.get_entity(source_channel)
                print(f"   âœ… ì±„ë„ëª…: {getattr(entity, 'title', 'N/A')}")
                print(f"   âœ… ì±„ë„ ID: {entity.id}")
                print(f"   âœ… Username: @{getattr(entity, 'username', 'N/A')}")
            except Exception as e:
                print(f"   âŒ ì±„ë„ ì¡°íšŒ ì‹¤íŒ¨: {e}")
                print(f"   ğŸ’¡ SOURCE_CHANNEL ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.")

        # TARGET_CHANNEL í™•ì¸
        target_channel = os.getenv("TARGET_CHANNEL")
        if target_channel:
            print()
            print(f"ğŸ“¤ TARGET_CHANNEL í™•ì¸ ì¤‘: {target_channel}")
            try:
                entity = await client.get_entity(target_channel)
                print(f"   âœ… ì±„ë„ëª…: {getattr(entity, 'title', 'N/A')}")
                print(f"   âœ… ì±„ë„ ID: {entity.id}")
                print(f"   âœ… Username: @{getattr(entity, 'username', 'N/A')}")
            except Exception as e:
                print(f"   âŒ ì±„ë„ ì¡°íšŒ ì‹¤íŒ¨: {e}")
                print(f"   ğŸ’¡ TARGET_CHANNEL ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.")

        print()
        print("=" * 80)
        print("âœ… Telegram ì—°ê²° í…ŒìŠ¤íŠ¸ ì™„ë£Œ!")
        print("=" * 80)

    except Exception as e:
        print()
        print("=" * 80)
        print(f"âŒ Telegram ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: {e}")
        print("=" * 80)

    finally:
        # í´ë¼ì´ì–¸íŠ¸ ì¢…ë£Œ
        await client.disconnect()


def main():
    """ë©”ì¸ í•¨ìˆ˜"""
    print()
    print("=" * 80)
    print("ğŸ”§ Telegram API ì„¤ì • ë„êµ¬")
    print("=" * 80)
    print()
    print("1. Telegram ì´ˆê¸° ì„¤ì • (ì „í™”ë²ˆí˜¸ ì¸ì¦)")
    print("2. Telegram ì—°ê²° í…ŒìŠ¤íŠ¸")
    print("3. ì¢…ë£Œ")
    print()

    choice = input("ì„ íƒ (1-3): ").strip()

    if choice == "1":
        asyncio.run(setup_telegram())
    elif choice == "2":
        asyncio.run(test_telegram_connection())
    elif choice == "3":
        print("âœ… í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.")
    else:
        print("âŒ ì˜ëª»ëœ ì„ íƒì…ë‹ˆë‹¤.")


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n\nâŒ ì‚¬ìš©ìì— ì˜í•´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.")
    except Exception as e:
        print(f"\n\nâŒ ì˜¤ë¥˜ ë°œìƒ: {e}")
