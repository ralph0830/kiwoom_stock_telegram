# 📈 키움증권 텔레그램 자동매매 시스템

키움증권 REST OpenAPI와 WebSocket, Telegram API를 활용한 **실시간 자동매매 시스템**입니다.

Telegram 채널에서 매수 신호를 실시간으로 감지하여 자동 매수하고, WebSocket으로 실시간 시세를 모니터링하여 목표 수익률 도달 시 자동으로 매도합니다.

## ✨ 주요 기능

### 📱 Telegram 실시간 감시
- Telegram 채널에서 **2가지 매수 신호 형식** 실시간 감지
  - ⭐ "Ai 종목포착 시그널" (기존)
  - ✅ "#매수신호" (신규)
- 📤 SOURCE 채널 → TARGET 채널로 모든 메시지 자동 복사
- 프로그램 시작 시 최근 메시지는 로그 확인용이며, **실시간 메시지만 자동 매수**
- ⚙️ **TARGET_CHANNEL 공란 설정 시 메시지 복사 비활성화** (매수/매도 모니터링은 계속 작동)

### 💰 자동 매수 (v1.6.0 업데이트!)
- ⚡ **시장가 즉시 매수** (기본값): 빠른 체결 보장 (0.8초), 슬리피지 +0.5~1%
- 🎯 **지정가 매수 (현재가+1틱)**: 유리한 가격 진입, 슬리피지 최소화, 미체결 리스크 있음
  - 부분 체결 자동 처리 (60% 이상 체결 시 나머지 자동 취소)
  - 미체결 시 시장가 재주문 (fallback) 선택 가능
- 📊 최대 투자금액 기준 자동 수량 계산
- ⏰ 매수 가능 시간 설정 (기본: 08:50 ~ 12:10)
- 🛡️ 일일 1회 매수 제한 (날짜 기준)

### 📈 자동 익절
- 🎯 목표 수익률 도달 시 지정가 매도 (한 틱 아래 가격)
- 💯 100% 전량 매도 (계좌 잔고 실시간 조회)
- 📊 수동 매수 종목도 자동 매도 (평균 매입단가 자동 반영)

### 🚨 자동 손절
- 📉 손절 수익률 도달 시 시장가 즉시 매도
- 💯 100% 전량 매도 (계좌 잔고 실시간 조회)
- ⏱️ **NEW! 손절 지연 기능**: 매수 후 지정 시간(기본 1분) 이내에는 손절하지 않음
- ⚙️ 활성화/비활성화 설정 가능

### ⏰ 일일 강제 청산
- 🕐 지정 시간(기본 15:19)에 수익/손실 관계없이 100% 전량 시장가 매도
- 🎯 장마감 전 포지션 청산으로 익일 갭 리스크 방지
- ⚙️ 활성화/비활성화 설정 가능

### 🔄 WebSocket 실시간 시세
- 📡 실시간 시세 모니터링 (PING/PONG 처리로 무제한 연결 유지)
- 🔁 자동 재연결 기능
- 📊 실시간 수익률 계산 및 출력

### 🛡️ 안전장치
- 🔒 일일 1회 매수 제한
- 🚫 중복 매도 방지
- ⏰ 매수 시간 제한
- 📊 세션 복원: 프로그램 재시작 시 계좌 잔고에서 매수 정보 복원

## 🚀 시작하기

### 📦 설치 방법

두 가지 설치 방법 중 선택하세요:

#### 옵션 A: Portable 패키지 (비전문가용) ⭐ 권장

**Python 설치 없이** 바로 실행 가능한 독립 실행 패키지입니다.

**특징**:
- ✅ Python 설치 불필요
- ✅ GUI 설정 도구 제공
- ✅ 원클릭 실행
- ✅ Windows 10+ 지원

**다운로드 및 실행**:
1. `stock_trading_v1.6.0_portable.zip` 다운로드
2. 압축 해제
3. `설정하기.lnk` 더블클릭 → 설정 입력
4. `자동매매 시작.lnk` 더블클릭 → 실행

**상세 가이드**: `portable/docs/USER_GUIDE.md` 참고

---

#### 옵션 B: 개발자 설치 (CLI)

**필요 사항**:
- Python 3.10 이상
- UV 패키지 매니저
- 키움증권 API 키 (실전투자 / 모의투자)
- Telegram API 인증 정보

**설치 단계**:

1. **저장소 클론**
```bash
git clone https://github.com/yourusername/stock_tel.git
cd stock_tel
```

2. **의존성 설치**
```bash
# UV 사용 (권장)
uv sync

# 또는 pip 사용
pip install -r requirements.txt
```

3. **환경 변수 설정**

`.env` 파일을 생성하고 다음 내용을 설정하세요:

> 💡 **팁**: `.env.example` 파일을 복사하여 시작하세요
> ```bash
> cp .env.example .env
> ```

```env
# ============================================================
# 모의투자/실전투자 설정
# ============================================================
USE_MOCK=false                 # 모의투자 설정 (true: 모의투자, false: 실전투자)
DEBUG=false                    # 디버그 모드 (true: 실시간 시세 계속 출력, false: 출력 안함)

# ============================================================
# 키움증권 API KEY
# ============================================================
# 실전투자 API KEY
KIWOOM_APP_KEY=your_real_app_key
KIWOOM_SECRET_KEY=your_real_secret_key

# 모의투자 API KEY
KIWOOM_MOCK_APP_KEY=your_mock_app_key
KIWOOM_MOCK_SECRET_KEY=your_mock_secret_key

# ============================================================
# 자동매매 설정
# ============================================================
ACCOUNT_NO=12345678-01         # 계좌번호
MAX_INVESTMENT=2000000         # 최대 투자금액 (원)
TARGET_PROFIT_RATE=1.0         # 목표 수익률 (%) - 기본값: 1.0%

# ============================================================
# 매수 가능 시간 설정
# ============================================================
BUY_START_TIME=08:50           # 매수 시작 시간
BUY_END_TIME=12:10             # 매수 종료 시간

# ============================================================
# 매수 주문 타입 설정 (v1.6.0)
# ============================================================
BUY_ORDER_TYPE=market          # 매수 주문 타입 선택
                               # - market: 시장가 즉시 매수 (기본값)
                               #   · 장점: 체결 속도 빠름 (0.8초), 100% 체결 보장
                               #   · 단점: 가격 슬리피지 있음 (+0.5~1%)
                               # - limit_plus_one_tick: 현재가+1틱 지정가 매수
                               #   · 장점: 유리한 가격 진입, 슬리피지 최소화
                               #   · 단점: 미체결 리스크 있음

# ============================================================
# 매수 체결 확인 설정 (지정가 주문 시만 사용, v1.6.0)
# ============================================================
BUY_EXECUTION_TIMEOUT=30       # 매수 체결 확인 타임아웃 (초)
                               # 권장값:
                               #   - 급등주: 15~20초 (빠른 결정 필요)
                               #   - 일반 종목: 30초 (여유 있게 대기)

BUY_EXECUTION_CHECK_INTERVAL=5 # 매수 체결 확인 주기 (초)
                               # 기본값: 5초
                               # 너무 짧게 설정 시 API 부하 발생 가능

# ============================================================
# 지정가 미체결 시 폴백 전략 (v1.6.0)
# ============================================================
BUY_FALLBACK_TO_MARKET=true    # 지정가 미체결 시 시장가 폴백 여부
                               # - true: 미체결 시 시장가로 재주문 (진입 기회 확보, 기본값)
                               # - false: 미체결 시 주문 취소하고 종료 (가격 우선)

# ============================================================
# 매도 모니터링 설정
# ============================================================
ENABLE_SELL_MONITORING=true    # 자동 매도 모니터링 활성화 (true: 활성화, false: 비활성화)

# ============================================================
# 손절 설정
# ============================================================
ENABLE_STOP_LOSS=true          # 손절 모니터링 활성화 (true: 활성화, false: 비활성화)
STOP_LOSS_RATE=-2.5            # 손절 수익률 (%) - 기본값: -2.5%
STOP_LOSS_DELAY_MINUTES=1      # 손절 지연 시간 (분) - 기본값: 1분
                               # 매수 후 이 시간 이내에는 손절하지 않음
                               # 0: 즉시 손절, >0: 지연 후 손절

# ============================================================
# 일일 강제 청산 설정
# ============================================================
ENABLE_DAILY_FORCE_SELL=true   # 일일 강제 청산 활성화 (true: 활성화, false: 비활성화)
DAILY_FORCE_SELL_TIME=15:19    # 강제 청산 시간 (기본값: 15:19 - 장마감 11분 전)

# ============================================================
# 미체결 주문 처리 설정
# ============================================================
CANCEL_OUTSTANDING_ON_FAILURE=true    # 미체결 시 주문 취소 여부 (true: 취소 후 재모니터링, false: 주문 유지)
OUTSTANDING_CHECK_TIMEOUT=30          # 체결 확인 타임아웃 (초) - 기본값: 30초
OUTSTANDING_CHECK_INTERVAL=5          # 체결 확인 주기 (초) - 기본값: 5초

# ============================================================
# 실시간 체결 정보 검증 설정
# ============================================================
ENABLE_LAZY_VERIFICATION=true         # 실시간 체결 정보 자동 검증
                                      # true: 개선 모드 - 즉시 모니터링 + 자동 업데이트
                                      # false: 기존 모드 - 추정값만 사용

# ============================================================
# 주기적 평균단가 업데이트 설정 (v1.4.0 - v1.5.0부터 기본 비활성화)
# ============================================================
BALANCE_CHECK_INTERVAL=0              # 계좌 조회 주기 (초)
                                      # 0: 비활성화 (기본값, 성능 최적화)
                                      # >0: 활성화 (수동 매수 시 평균 매입단가 자동 반영)
                                      # ⚡ 성능: 비활성화 시 매매 타이밍 최대 360ms 향상
                                      # 💡 사용법: 수동 매수 시 프로그램 재시작으로 자동 반영

# ============================================================
# Telegram API 설정 (필수)
# ============================================================
# https://my.telegram.org/auth 에서 발급받으세요
# 1. 전화번호로 로그인
# 2. "API development tools" 클릭
# 3. 앱 생성 (이름은 아무거나)
# 4. api_id와 api_hash 복사

API_ID=12345678
API_HASH=abcdef1234567890abcdef1234567890
SESSION_NAME=channel_copier

# ============================================================
# Telegram 채널 설정
# ============================================================
# 채널 지정 방법:
# 1. 공개 채널: https://t.me/channel_name 또는 @channel_name
# 2. 비공개 채널 (초대 링크): https://t.me/+invitelink
# 3. 비공개 채널 (채널 ID): -1001234567890
#
# 💡 팁: 채널 ID 확인 방법
#    - Telegram Web (https://web.telegram.org/a/)에서 채널 접속
#    - URL의 숫자 부분이 채널 ID (예: -1001234567890)

SOURCE_CHANNEL=https://t.me/your_source_channel  # 매수 신호를 받을 채널 (필수)
TARGET_CHANNEL=@your_target_channel              # 알림을 보낼 채널 (선택, 메시지 복사용)
```

**⚠️ 중요**: `.env` 파일은 절대 Git에 커밋하지 마세요! (`.gitignore`에 포함됨)

---

### 🎮 사용법

#### 방법 1: CLI 실행 (터미널)

```bash
# UV 사용 (권장)
uv run python auto_trading.py

# 또는 일반 Python
python auto_trading.py
```

**특징**:
- ✅ 터미널에서 직접 실행
- ✅ 로그가 콘솔에 실시간 출력
- ✅ 서버 환경에 적합
- ✅ SSH 원격 접속 가능

#### 방법 2: GUI 실행 (웹 대시보드)

```bash
# Streamlit 웹 대시보드 실행
streamlit run gui/app.py
```

**특징**:
- ✅ 웹 브라우저에서 모니터링
- ✅ 실시간 로그 확인
- ✅ 매매 기록 시각화
- ✅ 비전문가도 쉽게 사용

**접속**: 브라우저에서 `http://localhost:8501` 접속

> 💡 **원격 접속**: 다른 컴퓨터에서 접속하려면
> ```bash
> streamlit run gui/app.py --server.address=0.0.0.0
> # 접속: http://서버IP:8501
> ```

---

### 📨 지원하는 매수 신호 형식

시스템은 **2가지 매수 신호 형식**을 자동으로 감지합니다:

#### 형식 1: Ai 종목포착 시그널 (기존)

```
⭐️ Ai 종목포착 시그널
￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣
포착 종목명 : 유일에너테크 (340930)
적정 매수가 : 2,870원 👉 6.49%
포착 현재가 : 2,860원 👉 6.12%
```

**파싱 정보**:
- 종목명: 유일에너테크
- 종목코드: 340930
- 목표가: 2,870원 (적정 매수가)
- 현재가: 2,860원 (포착 현재가)

#### 형식 2: #매수신호 (신규 v1.6.1+)

```
✅ #매수신호
￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣
종목명 👉 벨로크 (424760)
매수가 👉 1,426원
등락률 👉 6.58%
￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣
매도가 👉 1,458원
```

**파싱 정보**:
- 종목명: 벨로크
- 종목코드: 424760
- 현재가: 1,426원 (매수가)
- 목표가: 1,458원 (매도가)

> 💡 **자동 감지**: 두 형식을 자동으로 구분하여 파싱하므로 별도 설정이 필요 없습니다!

---

### 📋 프로그램 동작 흐름

1. **Telegram 채널 연결 및 로그인**
2. **최근 메시지 조회** (로그 확인용)
3. **실시간 메시지 모니터링 시작**
4. **매수 신호 감지 시 자동 매수** ("Ai 종목포착 시그널" 또는 "#매수신호")
5. **WebSocket 실시간 시세 모니터링**
6. **목표 수익률/손절 수익률 도달 시 자동 매도**

### ⏹️ 종료

- **CLI**: `Ctrl + C`로 안전하게 종료
- **GUI**: 브라우저 탭만 닫으면 됨 (백그라운드 계속 실행)
  - 완전 종료: 터미널에서 `Ctrl + C`

---

### 🔄 업데이트 방법

#### Git Pull 업데이트

```bash
# 최신 코드 가져오기
git pull origin master

# 의존성 업데이트 (새 패키지 추가된 경우)
uv sync

# 환경 변수 확인 (.env.example 참고)
# 새로운 설정이 추가되었을 수 있음
```

#### Portable 패키지 업데이트

1. **설정 백업**
   ```
   data/ 폴더 전체를 USB나 다른 위치에 복사
   (설정 파일 및 Telegram 세션 포함)
   ```

2. **새 버전 다운로드**
   ```
   stock_trading_v1.7.0_portable.zip 다운로드
   ```

3. **설정 복원**
   ```
   새 버전 압축 해제 → 백업한 data/ 폴더 복사
   ```

4. **실행**
   ```
   자동매매 시작.lnk 더블클릭
   ```

> ⚠️ **주의**: `data/` 폴더를 백업하지 않으면 재설정이 필요합니다!

## 📊 시스템 아키텍처

```
┌─────────────────────┐
│  Telegram Channel   │ ──► 실시간 매수 신호 수신
└─────────────────────┘
          │
          ▼
┌─────────────────────┐
│  auto_trading.py    │ ──► 메인 자동매매 시스템
│  - 신호 파싱        │
│  - 매수 판단        │
│  - 매도 모니터링    │
└─────────────────────┘
          │
          ├──► ┌─────────────────────┐
          │    │  kiwoom_order.py    │ ──► REST API 주문 실행
          │    │  - 매수/매도 주문   │
          │    │  - 계좌 조회        │
          │    └─────────────────────┘
          │
          └──► ┌─────────────────────┐
               │ kiwoom_websocket.py │ ──► 실시간 시세 수신
               │  - 가격 모니터링    │
               │  - 자동 재연결      │
               └─────────────────────┘
```

## 📁 프로젝트 구조

```
stock_tel/
├── auto_trading.py              # 메인 자동매매 시스템 (Telegram 버전)
├── auto_trading_no_telegram.py  # 브라우저 기반 자동매매 시스템 (레거시)
├── kiwoom_order.py              # REST API 주문 처리
├── kiwoom_websocket.py          # WebSocket 실시간 시세
├── config.py                    # 설정 관리
├── trading_system_base.py       # 자동매매 기본 클래스
├── test_stop_loss_delay.py      # 손절 지연 기능 테스트
│
├── gui/                         # Streamlit 웹 대시보드 (v1.6.0+)
│   ├── app.py                   # 메인 대시보드 앱
│   └── utils/
│       ├── telegram_auth.py     # Telegram 재인증 관리
│       └── process_monitor.py   # 프로세스 모니터링
│
├── scripts/                     # 유틸리티 스크립트
│   └── telegram_auth.py         # CLI Telegram 인증
│
├── portable/                    # Portable 패키지 빌드 (v1.6.0+)
│   ├── build_portable.ps1       # PowerShell 빌드 스크립트
│   ├── build.bat                # 배치 빌드 스크립트 (영문)
│   ├── setup_gui.py             # Tkinter 설정 GUI
│   ├── launcher.py              # 통합 런처
│   ├── setup_gui.spec           # PyInstaller 설정
│   ├── scripts/                 # 실행 배치 스크립트
│   ├── templates/               # 템플릿 파일
│   ├── docs/                    # 배포 문서
│   ├── QUICK_START.md           # 빠른 시작 가이드
│   └── README.md                # Portable 패키지 설명
│
├── .env                         # 환경 변수 (직접 작성 필요)
├── .env.example                 # 환경 변수 예시 파일
├── pyproject.toml               # 프로젝트 설정 및 의존성
├── README.md                    # 본 문서 (사용자 가이드)
├── CLAUDE.md                    # 개발자 문서
│
├── daily_trading_lock.json      # 일일 매수 이력 (자동 생성)
├── trading_results/             # 매매 결과 기록 (자동 생성)
├── auto_trading.log             # 자동매매 로그 (자동 생성)
│
└── unused/                      # 사용하지 않는 레거시 코드
```

## ⚙️ 주요 기능 상세

### 1. 지정가 매수 기능 (v1.6.0)

시장가 매수 외에 **현재가+1틱 지정가 매수**를 선택할 수 있습니다.

#### 매수 전략 비교

| 구분 | 시장가 (market) | 지정가+1틱 (limit_plus_one_tick) |
|-----|----------------|--------------------------------|
| 체결 속도 | ⚡ 매우 빠름 (0.8초) | 🐢 변동적 (0~30초) |
| 체결 보장 | ✅ 100% 보장 | ⚠️ 미체결 리스크 있음 |
| 가격 슬리피지 | ❌ +0.5~1% | ✅ 최소화 |
| 권장 상황 | 급등주, 확실한 진입 | 일반 종목, 가격 우선 |

#### 설정 방법

```env
# 시장가 매수 (기본값)
BUY_ORDER_TYPE=market

# 지정가 매수 (현재가+1틱)
BUY_ORDER_TYPE=limit_plus_one_tick
BUY_EXECUTION_TIMEOUT=30       # 체결 확인 타임아웃 (초)
BUY_EXECUTION_CHECK_INTERVAL=5 # 체결 확인 주기 (초)
BUY_FALLBACK_TO_MARKET=true    # 미체결 시 시장가 폴백 (true/false)
```

#### 실행 시나리오

**A. 100% 체결**
```
현재가: 10,000원
주문가: 10,010원 (현재가 + 1틱)
→ 10,010원 이하로 100% 체결
→ 실제 평균 매입단가로 익절/손절 모니터링
```

**B. 부분 체결 (60% 이상)**
```
현재가: 10,000원
주문 수량: 100주
→ 70주 체결, 30주 미체결
→ 미체결 30주 자동 취소
→ 체결된 70주로 익절/손절 모니터링
```

**C. 미체결 + 시장가 폴백**
```
현재가: 10,000원
주문가: 10,010원
→ 30초 동안 0% 체결
→ BUY_FALLBACK_TO_MARKET=true
→ 시장가로 재주문 (즉시 체결)
```

**D. 미체결 + 주문 취소**
```
현재가: 10,000원
주문가: 10,010원
→ 30초 동안 0% 체결
→ BUY_FALLBACK_TO_MARKET=false
→ 주문 취소 후 매수 포기
```

#### 호가 단위 (틱)

현재가에 따라 자동으로 호가 단위가 결정됩니다:

| 현재가 범위 | 호가 단위 (1틱) | 예시 |
|-----------|---------------|-----|
| 1,000원 미만 | 1원 | 999원 → 1,000원 |
| 1,000~4,999원 | 5원 | 1,000원 → 1,005원 |
| 5,000~9,999원 | 10원 | 5,000원 → 5,010원 |
| 10,000~49,999원 | 50원 | 10,000원 → 10,050원 |
| 50,000~99,999원 | 100원 | 50,000원 → 50,100원 |
| 100,000~499,999원 | 500원 | 100,000원 → 100,500원 |
| 500,000원 이상 | 1,000원 | 500,000원 → 501,000원 |

### 2. 손절 지연 기능

매수 직후 급격한 가격 변동으로 인한 패닉 손절을 방지합니다.

**설정 방법**:
```env
STOP_LOSS_DELAY_MINUTES=1    # 1분 지연 (기본값)
STOP_LOSS_DELAY_MINUTES=0    # 즉시 손절 가능
STOP_LOSS_DELAY_MINUTES=3    # 3분 지연
```

**동작 방식**:
- 매수 후 설정된 시간(분) 이내에는 손절 조건이 도달해도 손절하지 않음
- 설정 시간 경과 후에는 정상적으로 손절 실행
- 프로그램 재시작 시에도 매수 시간이 복원되어 정상 작동

**예시**:
```
매수 시각: 09:00:00
손절 지연: 1분
손절 조건: -2.5%

09:00:30 → 손실률 -3.0% → 손절 안함 (1분 이내)
09:00:50 → 손실률 -3.0% → 손절 안함 (1분 이내)
09:01:00 → 손실률 -3.0% → 손절 실행! (1분 경과)
```

**테스트**:
```bash
# 손절 지연 기능 시뮬레이션 테스트
uv run python test_stop_loss_delay.py
```

### 3. 실시간 체결 정보 검증

**ENABLE_LAZY_VERIFICATION 설정**:

- `false` (기존 방식): 시장가 주문 시점의 현재가를 매수가로 사용 (추정값)
  - 장점: 빠른 매도 판단 가능 (즉시 모니터링)
  - 단점: 실제 체결가와 차이 발생 가능 (보통 0.5~1% 차이)

- `true` (개선 방식): 첫 실시간 시세 수신 시 계좌 조회로 실제 체결가 확인
  - 장점: 정확한 수익률 계산 (실제 평균 매입단가 기준)
  - 단점: 약 0.2초 추가 지연 발생

**권장 설정**:
- **빠른 대응 우선** (단기 급등주): `false`
- **정확한 수익률 우선** (목표 수익률 정확히 달성): `true`

### 4. 세션 복원

프로그램이 종료되어도 계좌 잔고에서 보유 종목을 자동으로 감지하여 매도 모니터링을 재개합니다.

**동작 방식**:
1. 프로그램 시작 시 계좌 잔고 조회
2. 보유 종목이 있으면 매수 정보 복원 (평균 매입단가 자동 반영)
3. WebSocket 매도 모니터링 시작
4. 목표 수익률 또는 손절 수익률 도달 시 자동 매도

### 5. 100% 전량 매도

매도 시점에 계좌 잔고를 실시간으로 조회하여 실제 보유 수량을 확인하고 100% 전량 매도합니다.

**장점**:
- 자동 매수 + 수동 매수 종목 모두 자동 매도
- 평균 매입단가 자동 반영
- 분할 매수 시에도 전량 매도

## 📝 로그 예시

### 매수 플로우
```
🚀 텔레그램 자동매매 시스템 시작
📊 실제 계좌 잔고 조회 중...
ℹ️ 보유 종목이 없습니다.
⏱️ Telegram 클라이언트 연결 시작...
✅ Telegram 연결 완료 (소요 시간: 0.766초)
✅ Telegram 로그인: Ralph (@RalphPa)
📥 매수 신호 모니터링 채널 (SOURCE_CHANNEL): @aitodaystock
📤 알림 전송 채널 (TARGET_CHANNEL): @ralphstock
💰 최대 투자금액: 3,000원
⏰ 매수 가능 시간: 08:50 ~ 09:10
👀 매수 신호 모니터링 시작... (Ctrl+C로 종료)

🔔 이벤트 핸들러 호출됨! (새 메시지 감지)
📨 텔레그램 메시지 수신
📤 메시지 복사 완료 (텍스트, TARGET: @ralphstock)
✅ 신호 파싱 완료: {'stock_name': 'HB테크놀러지', 'stock_code': '078150', ...}
🎯 종목 포착! 시장가 즉시 매수를 시작합니다
✅ 시장가 매수 주문 성공!
📈 WebSocket 실시간 시세 모니터링 시작 (목표: 2.00%)
```

### 익절 플로우
```
📊 실시간 시세 정보 (WebSocket)
수익률: +2.05% (목표: +2.00%, 손절: -2.50%)
🎯 목표 수익률 2% 도달! 자동 매도를 시작합니다
📊 계좌 잔고에서 실제 보유 정보를 조회합니다...
✅ 실제 보유 정보 확인:
   보유 수량: 1주
   평균 매입단가: 1,709원
💰 매도 수량: 1주 (100% 전량)
💰 매도 주문가: 1,740원 (목표가에서 한 틱 아래)
✅ 지정가 매도 주문 성공!
✅ 자동 매도 완료!
```

### 손절 플로우 (손절 지연 포함)
```
📊 실시간 시세 정보 (WebSocket)
수익률: -3.00% (목표: +2.00%, 손절: -2.50%)
⏱️ 손절 지연: 매수 후 0.5분 경과 (설정: 1분 이후부터 손절)

... (시간 경과) ...

📊 실시간 시세 정보 (WebSocket)
수익률: -3.00% (목표: +2.00%, 손절: -2.50%)
🚨 손절 조건 도달! (-2.5% 이하)
매수가: 10,000원
현재가: 9,700원
손실률: -3.00%
📊 계좌 잔고에서 실제 보유 수량을 조회합니다...
✅ 실제 보유 수량 확인: 100주
💰 손절 매도 수량: 100주 (100% 전량 시장가)
✅ 시장가 매도 주문 성공! (손절)
✅ 손절 매도 완료!
```

### 강제 청산 플로우
```
📊 실시간 시세 정보 (WebSocket)
수익률: +0.50% (목표: +2.00%, 손절: -2.50%)
================================================================================
⏰ 강제 청산 시간 도달! (15:19)
💰 보유 종목을 100% 전량 시장가 매도합니다
================================================================================
📊 계좌 잔고에서 실제 보유 수량을 조회합니다...
✅ 실제 보유 정보 확인:
   보유 수량: 100주
   평균 매입단가: 10,000원
💰 강제 청산 수량: 100주 (100% 전량 시장가)
✅ 시장가 매도 주문 성공!
✅ 강제 청산 완료!
```

## 🔧 문제 해결

### WebSocket 연결이 40초마다 끊김
- **해결됨**: PING/PONG 처리로 무제한 연결 유지

### 프로그램 재시작 시 매도 안됨
- **해결됨**: 계좌 잔고에서 매수 정보 자동 복원

### 하루에 여러 번 매수됨
- **해결됨**: `daily_trading_lock.json`으로 일일 1회 제한

### 실시간 체결 정보와 추정값 차이
- **해결 방법**: `ENABLE_LAZY_VERIFICATION=true`로 설정하여 실제 체결가 자동 확인

### 손절이 너무 빨리 실행됨
- **해결 방법**: `STOP_LOSS_DELAY_MINUTES`를 1 이상으로 설정하여 매수 직후 지연 시간 부여

## ⚠️ 주의사항

### 🚨 투자 리스크
- 본 시스템은 **교육 및 연구 목적**으로 제작되었습니다
- 실전 투자 시 **투자 손실 위험**이 있으며, 모든 책임은 사용자에게 있습니다
- **모의투자**로 충분히 테스트 후 실전 투자하시기 바랍니다

### 🔐 보안
- `.env` 파일은 절대 Git에 커밋하지 마세요
- API 키는 절대 공개하지 마세요
- 계좌 번호 등 민감한 정보는 철저히 관리하세요

### 📋 운영
- 장 시작 전에 프로그램을 실행하세요
- 일일 1회 매수 제한이 있으므로 신중하게 선택하세요
- 로그 파일(`auto_trading.log`)을 주기적으로 확인하세요
- 매매 결과는 `trading_results/` 디렉토리에 자동 저장됩니다

### 🛠️ 개발
- 코드 수정 시 반드시 테스트를 거치세요
- 새로운 기능 추가 시 `CLAUDE.md` 문서를 업데이트하세요
- Git 커밋 메시지는 명확하게 작성하세요

## 📄 라이선스

본 프로젝트는 개인 학습 및 연구 목적으로 사용할 수 있습니다.

## 📞 문의

프로젝트 관련 문의사항이 있으시면 Issue를 등록해 주세요.

---

**⚡ Happy Trading! 📈**
